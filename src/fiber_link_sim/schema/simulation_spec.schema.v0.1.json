{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "fiber-physics.simulation-spec.schema.v0.1",
  "title": "Fiber Physics SimulationSpec",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "v",
    "path",
    "fiber",
    "spans",
    "signal",
    "transceiver",
    "processing",
    "propagation",
    "runtime",
    "outputs"
  ],
  "properties": {
    "v": {
      "type": "string",
      "minLength": 1,
      "description": "Spec version for backward compatibility."
    },
    "scenario": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string"
        },
        "description": {
          "type": "string"
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "metadata": {
          "type": "object",
          "additionalProperties": true,
          "description": "Non-physics metadata for UI/MCP organization."
        }
      }
    },
    "path": {
      "$ref": "#/$defs/Path"
    },
    "fiber": {
      "$ref": "#/$defs/Fiber"
    },
    "spans": {
      "$ref": "#/$defs/Spans"
    },
    "signal": {
      "$ref": "#/$defs/Signal"
    },
    "transceiver": {
      "$ref": "#/$defs/Transceiver"
    },
    "processing": {
      "$ref": "#/$defs/Processing"
    },
    "propagation": {
      "$ref": "#/$defs/Propagation"
    },
    "runtime": {
      "$ref": "#/$defs/Runtime"
    },
    "outputs": {
      "$ref": "#/$defs/Outputs"
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "signal": {
            "properties": {
              "format": {
                "const": "coherent_qpsk"
              }
            }
          }
        }
      },
      "then": {
        "properties": {
          "transceiver": {
            "properties": {
              "rx": {
                "properties": {
                  "coherent": {
                    "const": true
                  }
                }
              }
            }
          },
          "signal": {
            "properties": {
              "n_pol": {
                "enum": [
                  2
                ]
              }
            }
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "signal": {
            "properties": {
              "format": {
                "enum": [
                  "imdd_ook",
                  "imdd_pam4"
                ]
              }
            }
          }
        }
      },
      "then": {
        "properties": {
          "transceiver": {
            "properties": {
              "rx": {
                "properties": {
                  "coherent": {
                    "const": false
                  }
                }
              }
            }
          },
          "signal": {
            "properties": {
              "n_pol": {
                "enum": [
                  1
                ]
              }
            }
          },
          "propagation": {
            "properties": {
              "model": {
                "enum": [
                  "scalar_glnse"
                ]
              }
            }
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "propagation": {
            "properties": {
              "model": {
                "const": "manakov"
              }
            }
          }
        }
      },
      "then": {
        "properties": {
          "signal": {
            "properties": {
              "n_pol": {
                "enum": [
                  2
                ]
              }
            }
          }
        }
      }
    }
  ],
  "$defs": {
    "Path": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "segments",
        "geo"
      ],
      "properties": {
        "segments": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/$defs/PathSegment"
          }
        },
        "geo": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "enabled",
            "polyline_wgs84"
          ],
          "properties": {
            "enabled": {
              "type": "boolean"
            },
            "polyline_wgs84": {
              "type": "array",
              "description": "Optional polyline points [lon, lat]. Used by the routing product; not required for physics.",
              "items": {
                "type": "array",
                "minItems": 2,
                "maxItems": 2,
                "items": {
                  "type": "number"
                }
              }
            }
          }
        }
      }
    },
    "PathSegment": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "length_m"
      ],
      "properties": {
        "length_m": {
          "type": "number",
          "exclusiveMinimum": 0
        },
        "temp_c": {
          "type": "number"
        },
        "notes": {
          "type": "string"
        }
      }
    },
    "Fiber": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "alpha_db_per_km",
        "beta2_s2_per_m",
        "gamma_w_inv_m",
        "n_group"
      ],
      "properties": {
        "alpha_db_per_km": {
          "type": "number",
          "minimum": 0
        },
        "beta2_s2_per_m": {
          "type": "number"
        },
        "beta3_s3_per_m": {
          "type": "number"
        },
        "gamma_w_inv_m": {
          "type": "number",
          "minimum": 0
        },
        "pmd_ps_sqrt_km": {
          "type": "number",
          "minimum": 0
        },
        "n_group": {
          "type": "number",
          "exclusiveMinimum": 1.0
        }
      }
    },
    "Spans": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "mode",
        "span_length_m",
        "amplifier"
      ],
      "properties": {
        "mode": {
          "type": "string",
          "enum": [
            "from_path_segments",
            "fixed_span_length"
          ]
        },
        "span_length_m": {
          "type": "number",
          "exclusiveMinimum": 0
        },
        "amplifier": {
          "$ref": "#/$defs/Amplifier"
        }
      }
    },
    "Amplifier": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "type",
        "mode"
      ],
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "none",
            "edfa"
          ]
        },
        "mode": {
          "type": "string",
          "enum": [
            "none",
            "auto_gain",
            "fixed_gain"
          ]
        },
        "noise_figure_db": {
          "type": "number",
          "minimum": 0
        },
        "max_gain_db": {
          "type": "number",
          "minimum": 0
        },
        "fixed_gain_db": {
          "type": "number"
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "type": {
                "const": "none"
              }
            }
          },
          "then": {
            "properties": {
              "mode": {
                "enum": [
                  "none"
                ]
              }
            },
            "not": {
              "anyOf": [
                {
                  "required": [
                    "noise_figure_db"
                  ]
                },
                {
                  "required": [
                    "max_gain_db"
                  ]
                },
                {
                  "required": [
                    "fixed_gain_db"
                  ]
                }
              ]
            }
          }
        },
        {
          "if": {
            "properties": {
              "type": {
                "const": "edfa"
              }
            }
          },
          "then": {
            "required": [
              "noise_figure_db"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "mode": {
                "const": "auto_gain"
              }
            }
          },
          "then": {
            "required": [
              "max_gain_db"
            ]
          }
        },
        {
          "if": {
            "properties": {
              "mode": {
                "const": "fixed_gain"
              }
            }
          },
          "then": {
            "required": [
              "fixed_gain_db"
            ]
          }
        }
      ]
    },
    "Signal": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "format",
        "symbol_rate_baud",
        "rolloff",
        "n_pol",
        "frame"
      ],
      "properties": {
        "format": {
          "type": "string",
          "enum": [
            "coherent_qpsk",
            "imdd_ook",
            "imdd_pam4"
          ]
        },
        "symbol_rate_baud": {
          "type": "number",
          "exclusiveMinimum": 0
        },
        "rolloff": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "n_pol": {
          "type": "integer",
          "enum": [
            1,
            2
          ]
        },
        "frame": {
          "$ref": "#/$defs/Frame"
        }
      }
    },
    "Frame": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "payload_bits",
        "preamble_bits",
        "pilot_bits"
      ],
      "properties": {
        "payload_bits": {
          "type": "integer",
          "minimum": 1
        },
        "preamble_bits": {
          "type": "integer",
          "minimum": 0
        },
        "pilot_bits": {
          "type": "integer",
          "minimum": 0
        }
      }
    },
    "Transceiver": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "tx",
        "rx"
      ],
      "properties": {
        "tx": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "laser_linewidth_hz",
            "launch_power_dbm"
          ],
          "properties": {
            "laser_linewidth_hz": {
              "type": "number",
              "minimum": 0
            },
            "launch_power_dbm": {
              "type": "number"
            }
          }
        },
        "rx": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "coherent",
            "lo_linewidth_hz",
            "adc",
            "noise"
          ],
          "properties": {
            "coherent": {
              "type": "boolean"
            },
            "lo_linewidth_hz": {
              "type": "number",
              "minimum": 0
            },
            "adc": {
              "type": "object",
              "additionalProperties": false,
              "required": [
                "sample_rate_hz",
                "bits"
              ],
              "properties": {
                "sample_rate_hz": {
                  "type": "number",
                  "exclusiveMinimum": 0
                },
                "bits": {
                  "type": "integer",
                  "minimum": 1,
                  "maximum": 16
                }
              }
            },
            "noise": {
              "type": "object",
              "additionalProperties": false,
              "required": [
                "thermal",
                "shot"
              ],
              "properties": {
                "thermal": {
                  "type": "boolean"
                },
                "shot": {
                  "type": "boolean"
                }
              }
            }
          }
        }
      }
    },
    "Processing": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "dsp_chain",
        "fec"
      ],
      "properties": {
        "autotune": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "enabled": {
              "type": "boolean"
            },
            "budget_trials": {
              "type": "integer",
              "minimum": 1
            },
            "targets": {
              "type": "array",
              "items": {
                "type": "string",
                "enum": [
                  "max_net_after_fec"
                ]
              }
            }
          }
        },
        "dsp_chain": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/DspBlock"
          }
        },
        "fec": {
          "$ref": "#/$defs/Fec"
        }
      }
    },
    "DspBlock": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "name",
        "enabled",
        "params"
      ],
      "properties": {
        "name": {
          "type": "string",
          "enum": [
            "resample",
            "matched_filter",
            "cd_comp",
            "mimo_eq",
            "ffe",
            "cpr",
            "demap"
          ]
        },
        "enabled": {
          "type": "boolean"
        },
        "params": {
          "type": "object",
          "additionalProperties": true,
          "description": "Block-specific parameters; validated by physics code per block."
        }
      }
    },
    "Fec": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "enabled",
        "scheme",
        "code_rate",
        "params"
      ],
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "scheme": {
          "type": "string",
          "enum": [
            "none",
            "ldpc"
          ]
        },
        "code_rate": {
          "type": "number",
          "minimum": 0.1,
          "maximum": 1.0
        },
        "params": {
          "type": "object",
          "additionalProperties": true
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "enabled": {
                "const": false
              }
            }
          },
          "then": {
            "properties": {
              "scheme": {
                "enum": [
                  "none"
                ]
              },
              "code_rate": {
                "const": 1.0
              }
            }
          }
        }
      ]
    },
    "Propagation": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "model",
        "backend",
        "effects",
        "ssfm"
      ],
      "properties": {
        "model": {
          "type": "string",
          "enum": [
            "scalar_glnse",
            "manakov"
          ]
        },
        "backend": {
          "type": "string",
          "enum": [
            "builtin_ssfm"
          ]
        },
        "effects": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "dispersion",
            "nonlinearity",
            "ase",
            "pmd",
            "env_effects"
          ],
          "properties": {
            "dispersion": {
              "type": "boolean"
            },
            "nonlinearity": {
              "type": "boolean"
            },
            "ase": {
              "type": "boolean"
            },
            "pmd": {
              "type": "boolean"
            },
            "env_effects": {
              "type": "boolean"
            }
          }
        },
        "ssfm": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "dz_m",
            "step_adapt"
          ],
          "properties": {
            "dz_m": {
              "type": "number",
              "exclusiveMinimum": 0
            },
            "step_adapt": {
              "type": "boolean"
            }
          }
        }
      }
    },
    "Runtime": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "seed",
        "n_symbols",
        "samples_per_symbol",
        "max_runtime_s"
      ],
      "properties": {
        "seed": {
          "type": "integer",
          "minimum": 0
        },
        "n_symbols": {
          "type": "integer",
          "minimum": 128
        },
        "samples_per_symbol": {
          "type": "integer",
          "minimum": 1,
          "maximum": 64
        },
        "max_runtime_s": {
          "type": "number",
          "exclusiveMinimum": 0
        }
      }
    },
    "Outputs": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "artifact_level",
        "return_waveforms"
      ],
      "properties": {
        "artifact_level": {
          "type": "string",
          "enum": [
            "none",
            "basic",
            "debug"
          ]
        },
        "return_waveforms": {
          "type": "boolean"
        }
      }
    }
  }
}
